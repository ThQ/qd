#!/bin/bash

source ./config

# $0 : Source files
# $1 : Output
# $2 : Temporary directory
function compile_project() {
   local_CXX="$1"
   local_sources=$2
   local_output="$3"
   local_dTmp="$4"

   echo "[X=$local_CXX] [src=$local_sources] [out=$local_output]"
   had_changed="no"
   has_errors=""
   cd "$local_dTmp"

   for file in ${local_sources[*]} ; do
      if [ ! -d "$dTmp${file%/*}" ] ; then
         mkdir -p "$dTmp${file%/*}"
      fi
      file_to_compile="$local_dTmp${file}.o"
      file_src_mtime=`stat --format="%y" $file`
      file_dst_mtime=0
      [ -f "$file_to_compile" ] && file_dst_mtime=`stat --format="%y" $file_to_compile`

      if [ "$file_src_mtime" != "$file_dst_mtime" ] ; then
         echo " CC $file"
         $local_CXX -c $file -o "$file_to_compile"
         if [ "$?" != "0" ] ; then
            has_errors="y"
            [ -f "$file_to_compile" ] && rm "$file_to_compile"
         fi
         touch $file_to_compile --date="$file_src_mtime"
         had_changed="yes"
      fi
   done

   if [ "$has_errors" == "" ] ; then
      if [ "$had_changed" == "yes" ] || [ ! -f "$local_output" ] ; then
         objects=""
         for file in ${local_sources} ; do
            objects="$objects$local_dTmp${file}.o "
         done
         echo " LD $objects"
         $local_CXX -o $local_output $objects
      fi
   fi
}

echo "Qd-compile [$1]"
if ["$1" == "vm" ]; then
   compile_project "$vm_CXX $CXX_RELEASE_FLAGS" "${vm_SOURCES[*]}" "$vm_OUTPUT" "$dTmp"
elif [ "$1" == "vm-debug" ] ; then
   compile_project "$vm_CXX $CXX_DEBUG_FLAGS" "${vm_SOURCES[*]}" "$vm_OUTPUT" "$dTmp"
elif [ "$1" == "vm-introspection" ] ; then
   compile_project "$vm_CXX $CXX_INTROSPECTION_FLAGS" "${vm_SOURCES[*]}" "$vm_OUTPUT" "$dTmp"
elif [ "$1" == "vm-internal" ] ; then
   compile_project "$vm_CXX $CXX_INTERNAL_FLAGS" "${vm_SOURCES[*]}" "$vm_OUTPUT" "$dTmp"

# --------------
#     TYPES
# --------------
elif [ "$1" == "t" ] ; then
   compile_project "$t_CXX $CXX_INTERNAL_FLAGS" "${t_SOURCES[*]}" "$t_OUTPUT" "$dTmp"
elif [ "$1" == "t_array" ] ; then
   compile_project "$t_array_CXX $CXX_INTERNAL_FLAGS" "${t_array_SOURCES[*]}" "$t_array_OUTPUT" "$dTmp"
elif [ "$1" == "t_exception" ] ; then
   compile_project "$t_exception_CXX $CXX_INTERNAL_FLAGS" "${t_exception_SOURCES[*]}" "$t_exception_OUTPUT" "$dTmp"
elif [ "$1" == "t_list" ] ; then
   compile_project "$t_list_CXX $CXX_INTERNAL_FLAGS" "${t_list_SOURCES[*]}" "$t_list_OUTPUT" "$dTmp"
elif [ "$1" == "t_map" ] ; then
   compile_project "$t_map_CXX $CXX_INTERNAL_FLAGS" "${t_map_SOURCES[*]}" "$t_map_OUTPUT" "$dTmp"
elif [ "$1" == "t_object" ] ; then
   compile_project "$t_object_CXX $CXX_INTERNAL_FLAGS" "${t_object_SOURCES[*]}" "$t_object_OUTPUT" "$dTmp"
elif [ "$1" == "t_string" ] ; then
   compile_project "$t_string_CXX $CXX_INTERNAL_FLAGS" "${t_string_SOURCES[*]}" "$t_string_OUTPUT" "$dTmp"

# --------------
#      VM
# --------------
elif [ "$1" == "vm_heap" ] ; then
   compile_project "$vm_heap_CXX $CXX_INTERNAL_FLAGS" "${vm_heap_SOURCES[*]}" "$vm_heap_OUTPUT" "$dTmp"

else
   echo "Can't find item [${1}] to compile."
fi
