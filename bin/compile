#!/bin/bash

source ./config

# $0 : Source files
# $1 : Output
# $2 : Temporary directory
function compile_project() {
   local_CXX="$1"
   local_sources=$2
   local_output="$3"
   local_dTmp="$4"

   echo "[X=$local_CXX] [src=$local_sources] [out=$local_output]"
   had_changed="no"
   has_errors=""
   cd "$local_dTmp"

   for file in ${local_sources[*]} ; do
      if [ ! -d "$dTmp${file%/*}" ] ; then
         mkdir -p "$dTmp${file%/*}"
      fi
      file_to_compile="$local_dTmp${file}.o"
      file_src_mtime=`stat --format="%y" $file`
      file_dst_mtime=0
      [ -f "$file_to_compile" ] && file_dst_mtime=`stat --format="%y" $file_to_compile`

      if [ "$file_src_mtime" != "$file_dst_mtime" ] ; then
         echo " CC $file"
         $local_CXX -c $file -o "$file_to_compile"
         if [ "$?" != "0" ] ; then
            has_errors="y"
            [ -f "$file_to_compile" ] && rm "$file_to_compile"
         fi
         touch $file_to_compile --date="$file_src_mtime"
         had_changed="yes"
      fi
   done

   if [ "$has_errors" == "" ] ; then
      if [ "$had_changed" == "yes" ] || [ ! -f "$local_output" ] ; then
         objects=""
         for file in ${local_sources} ; do
            objects="$objects$local_dTmp${file}.o "
         done
         echo " LD $objects"
         $local_CXX -o $local_output $objects
      fi
   fi
}

echo "Qd-compile [$1]"
if [ "$1" == "t" ] ; then
   compile_project "$svm_t_CXX" "${t_SOURCES[*]}" "$svm_t_OUTPUT" "$dTmp"
elif [ "$1" == "debug" ] ; then
   compile_project "$debug_CXX" "${debug_SOURCES[*]}" "$debug_OUTPUT" "$dTmp"
elif [ "$1" == "introspection" ] ; then
   compile_project "$svm_introspection_CXX" "${release_SOURCES[*]}" "$svm_introspection_OUTPUT" "$dTmp"

# --------------
#     TYPES
# --------------
elif [ "$1" == "t_array" ] ; then
   compile_project "$t_array_CXX" "${t_array_SOURCES[*]}" "$t_array_OUTPUT" "$dTmp"

elif [ "$1" == "t_map" ] ; then
   compile_project "$t_map_CXX" "${t_map_SOURCES[*]}" "$t_map_OUTPUT" "$dTmp"

else
   echo "Can't find item [${1}] to compile."
fi
