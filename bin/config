#!/bin/bash

progdir=`dirname $0`
cd $progdir

echo $PWD
dRoot="$PWD/.."
dData="$dRoot/data"
dBin="$dRoot/bin"
dBuild="$dRoot/build"
dBuildInclude="${dBuild}/include"
dBuildModuleInclude="$dBuildInclude/modules"
dBuildSrc="$dBuild/src"
dModules="$dRoot/modules"
dScript="$dRoot/script"
dTmp="/tmp"

xPython="python"
xReplace="${xPython} ${dScript}/replace.py"
xSh="bash"

CXX_DEBUG_FLAGS=" -pg -O0 -D __DEBUG__=1 -D USE_COLORS=1"
CXX_INTERNAL_FLAGS=" -pg -O0 -D __INTERNAL__=1 -D USE_COLORS=1"
CXX_INTROSPECTION_FLAGS=" -pg -O0 -D __INTROSPECTION__=1 -D USE_COLORS=1"
CXX_RELEASE_FLAGS=" -pg -O0 -D __RELEASE__=1"

base_SOURCES_TYPES=( \
$dRoot/src/t/Array.cpp \
$dRoot/src/t/Block.cpp \
$dRoot/src/t/Bool.cpp \
$dRoot/src/t/Collection.cpp \
$dRoot/src/t/CoreFunction.cpp \
$dRoot/src/t/Exception.cpp \
$dRoot/src/t/Float.cpp \
$dRoot/src/t/Function.cpp \
$dRoot/src/t/HeapObject.cpp \
$dRoot/src/t/List.cpp \
# $dRoot/src/t/Map.cpp \
$dRoot/src/t/Object.cpp \
$dRoot/src/t/String.cpp \
$dRoot/src/t/UnicodeString.cpp \
$dRoot/src/t/UserFunction.cpp \
$dRoot/src/t/UserObject.cpp \
$dRoot/src/t/Variable.cpp \
)

base_SOURCES=( \
$dRoot/src/debug.cpp \
$dRoot/src/Stats.cpp \
$dRoot/src/vm/Class.cpp \
$dRoot/src/vm/ClassTable.cpp \
$dRoot/src/vm/ClassTableEntry.cpp \
$dRoot/build/src/vm/EngineStarter.cpp \
$dRoot/build/src/vm/Engine.cpp \
$dRoot/src/vm/FieldTable.cpp \
$dRoot/src/vm/FunctionTable.cpp \
$dRoot/src/vm/FunctionTableEntry.cpp \
$dRoot/src/vm/Heap.cpp \
$dRoot/src/vm/OpCode.cpp \
$dRoot/src/vm/Parser.cpp \
$dRoot/src/vm/Stack.cpp \
)

base_utils_SOURCES=( \
$dRoot/src/util/Class.cpp \
$dRoot/src/util/Int.cpp \
$dRoot/src/util/List.cpp \
$dRoot/src/util/Object.cpp \
$dRoot/src/util/String.cpp \
)

vm_SOURCES=( ${base_SOURCES_TYPES[@]} ${base_utils_SOURCES[@]} ${base_SOURCES[@]} $dRoot/src/main.cpp )


t_SOURCES=( ${base_SOURCES_TYPES[@]} $dRoot/src/main_t.cpp $dRoot/src/vm/Heap.cpp )


bin_PROGRAMS="vm"

vm_CXXFLAGS="-I$dBuild/include -I$dRoot/include -Wall"
vm_LDADD="-licui18n -licuuc -licudata"
vm_CXX="g++ $vm_CXXFLAGS $vm_LDADD -DPACKAGE_NAME=\"Qd\" -DPACKAGE_AUTHOR_NAME=\"ThomasQuemard\" -DPACKAGE_VERSION=\""`cat $dRoot/VERSION`"\""
vm_OUTPUT="$dBuild/qd"

t_CXX="$vm_CXX -pg -O0 -D __INTROSPECTION__=1 -D USE_COLORS=1"
t_OUTPUT="$vm_OUTPUT"

t_xxx_SOURCES=( $dRoot/src/vm/Class.cpp $dRoot/src/t/Object.cpp $dRoot/src/util/Object.cpp $dRoot/src/Stats.cpp )
# ---------------
#      TYPES
# ---------------
t_object_SOURCES=( ${t_xxx_SOURCES[@]} $dRoot/src/main_t_object.cpp )
t_object_CXX="$vm_CXX"
t_object_OUTPUT="${vm_OUTPUT}-t-object"

t_array_SOURCES=( ${t_xxx_SOURCES[@]} $dRoot/src/t/Array.cpp $dRoot/src/t/Collection.cpp $dRoot/src/main_t_array.cpp )
t_array_CXX="$vm_CXX"
t_array_OUTPUT="${vm_OUTPUT}-t-array"

t_exception_SOURCES=( ${t_xxx_SOURCES[@]} $dRoot/src/t/Exception.cpp $dRoot/src/t/List.cpp $dRoot/src/t/String.cpp $dRoot/src/main_t_exception.cpp )
t_exception_CXX="$vm_CXX"
t_exception_OUTPUT="$vm_OUTPUT-t-exception"

t_list_SOURCES=( ${t_xxx_SOURCES[@]} $dRoot/src/t/List.cpp $dRoot/src/t/Collection.cpp $dRoot/src/main_t_list.cpp )
t_list_CXX="$vm_CXX"
t_list_OUTPUT="$vm_OUTPUT-t-list"

t_map_SOURCES=( ${t_xxx_SOURCES[@]} $dRoot/src/t/Map.cpp $dRoot/src/t/Collection.cpp $dRoot/src/main_t_map.cpp )
t_map_CXX="$vm_CXX"
t_map_OUTPUT="$vm_OUTPUT-t-map"

t_string_SOURCES=( ${t_xxx_SOURCES[@]} $dRoot/src/t/String.cpp $dRoot/src/t/Collection.cpp $dRoot/src/main_t_string.cpp )
t_string_CXX="$vm_CXX"
t_string_OUTPUT="${vm_OUTPUT}-t-string"

# ---------------
#       VM
# ---------------

vm_heap_SOURCES=( $dRoot/src/vm/Heap.cpp $dRoot/src/t/Object.cpp $dRoot/src/t/HeapObject.cpp )
vm_heap_CXX="$vm_CXX"
vm_heap_OUTPUT="${vm_OUTPUT}-vm-heap
